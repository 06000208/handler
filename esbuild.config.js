/* eslint-disable no-unused-vars */
import esbuild from "esbuild";
import process from "process";
import console from "node:console";

const production = (process.argv[2] === "--production");
const banner = `/*
This is a bundled/transpiled file generated by esbuild
If you want to view the source, please visit the github repository
*/`;

const build = (name, config) => {
    return esbuild.build({
        bundle: true,
        external: ["./node_modules/*"],
        watch: production ? false : {
            onRebuild(error, result) {
                if (error) {
                    console.error(`[watch] building ${name} failed:`, error);
                } else {
                    const { stop, ...alerts } = result;
                    console.log(`[watch] built ${name}:`, alerts);
                }
            },
        },
        target: "es2020",
        ...config,
    }).then((result) => {
        const { stop, ...alerts } = result;
        console.log(`built ${name}:`, alerts);
    }).catch((error) => {
        console.error(`building ${name} failed:`, error);
        process.exit(1);
    });
};

const builds = [
    build("browser esm", {
        entryPoints: ["./src/index.browser.js"],
        format: "esm",
        platform: "browser",
        banner: {
            js: banner,
        },
        outfile: "./dist/index.browser.js",
    }),
    build("minified browser esm", {
        entryPoints: ["./src/index.browser.js"],
        minify: true,
        format: "esm",
        platform: "browser",
        outfile: "./dist/index.browser.min.js",
    }),
    build("node esm", {
        entryPoints: ["./src/index.js"],
        format: "esm",
        platform: "node",
        banner: {
            js: banner,
        },
        outfile: "./dist/index.js",
    }),
    build("node cjs", {
        entryPoints: ["./src/index.cjs.js"],
        format: "cjs",
        platform: "node",
        banner: {
            js: banner,
        },
        outfile: "./dist/index.cjs",
    }),
];

if (!production) {
    Promise.all(builds).then(() => {
        console.log("watch mode enabled...");
    });
}
